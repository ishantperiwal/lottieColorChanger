<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
  rel="stylesheet"
/>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lottie Segment Marker Editor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; max-width: 1024px; margin: 0 auto; padding: 20px;   background: #f5f5f5; }
    h1 { margin-bottom: 16px; }
    .container { display: flex; flex-direction: column; gap: 20px; }

    /* Animation preview + main play */
    #preview-wrapper { position: relative; background: #f5f5f5; border-radius: 32px;   background-image: linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
                        linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
                        linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
                        linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
      background-size: 20px 20px;
      background-position: 0 0, 0 10px, 10px -10px, -10px 0px;}
    #animation-container { width: 100%; height: 400px;  border-radius: 8px; overflow: hidden; margin-bottom: 3rem;}
    .main-play-btn {
      position: absolute; bottom: 8px; left: 8px; z-index: 5;
      padding: 6px 12px; background: #007bff; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;
    }

    #globalBar { position: relative; height: 8px; background: #ddd; border-radius: 4px; margin-top: 8px; width: 100%; flex: 1;}

    .controls { display: flex; flex-direction: column; gap: 16px; }
    .button-group { display: flex; gap: 10px; }
    button { padding: 8px 16px; background: #4CAF50; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    button:disabled { background: #ccc; cursor: not-allowed; }

    #segmentsContainer { display: flex; flex-direction: column; gap: 12px; }
    .segment-control { padding: 12px; background: #fafafa; border-radius: 4px; display: flex;  gap: 8px; }
    .segment-header { display: flex; align-items: center; gap: 24px; width: 100%; }    .frame-input{background-color: #f5f5f5 !important;}
    .segment-name { padding: 4px 8px; font-size: 14px; width: 80px; }
    .frame-input { width: 70px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; }
    .play-btn, .download-btn { height: 2rem; width: 2rem; border: none; border-radius: 999px; cursor: pointer; }
    .download-btn { background: #007bff; color: #fff; }

    .range-container { position: relative; height: 24px; box-sizing: border-box; padding: 0 7px; }
    .range-highlight { position: absolute; top: 10px; height: 4px; border-radius: 2px; border-left: 2px solid; border-right: 2px solid; z-index: 1; }
    .range-input {
      -webkit-appearance: none; width: 100%; height: 16px; background: transparent; margin: 0; padding: 0;
      position: absolute; top: 0; pointer-events: none; z-index: 2;
    }
    .range-input::-webkit-slider-runnable-track { background: transparent; }
    .range-input::-webkit-slider-thumb {
      -webkit-appearance: none; pointer-events: all; width: 16px; height: 16px;
      border-radius: 50%; background: #007bff; border: none; cursor: pointer; margin-top: -6px; z-index: 3;
    }
    .range-input::-moz-range-track { background: transparent; }
    .range-input::-moz-range-thumb {
      pointer-events: all; width: 16px; height: 16px; border-radius: 50%;
      background: #007bff; border: none; cursor: pointer; margin-top: 0; z-index: 3;
    }

    #status { font-style: italic; color: #666; }
    #error { color: #f44336; }

/* some ui improvements */


/* make each segment row a flex container */
.segment-control {
  display: flex;
  align-items: center;
  gap: 16px;
  border-radius: 24px;
  padding: 20px;
  background: #fff;
}

/* left “info” column: name above the two frame numbers */

/* stack start/end inputs vertically */
.segment-info {
  display: flex;
  flex-direction: column;
  gap: 8px;

}
.frame-inputs {
 display: flex;

 gap: 2px;

}


/* the slider handles take up the remaining horizontal space */
.segment-handles {
  flex: 1;
}

/* right-side actions (Play / Download) stacked vertically */
.segment-actions {
  display: flex;

  gap: 10px;
  margin-left: 16px;
}

/* segment input stylings*/

.segment-name,
.frame-input {
  height: 20px;
  background: none;
  border: none;              /* light gray border */
  border-radius: 999px;                  /* pill-shaped corners */
  padding: 4px 14px;                    /* a bit of breathing room */
  transition: border-color 0.2s ease,  /* smooth color change */
              box-shadow 0.2s ease;    /* smooth shadow on focus */
}


.frame-input::-webkit-outer-spin-button,
.frame-input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
.frame-input {
  -moz-appearance: textfield;
}

/* hover state */
.segment-name:hover,
.frame-input:hover {
    background: #fff;
  border-color: #888;                  /* darken border on hover */
}

/* focus state */
.segment-name:focus,
.frame-input:focus {
  outline: none;                       /* remove default outline */
  border-color: #007bff;               /* blue border on focus */
  box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.frame-input{
  width: 30px;
  background: #fff;
  margin-right: 8px;
}

.segment-frames {
  font-size: 0.9rem;
  color: #555;
}

.segment-info{
  width: 140px;
}



/*Segment handles*/
/* 1) full‐length dull track behind everything */
.range-container::before {
  content: "";
  position: absolute;
  top: 50%;
  left: 0;
  width: 100%;
  height: 6px;                  /* track thickness */
  background: #ddd;             /* dull color */
  border-radius: 3px;
  transform: translateY(-50%);
  z-index: 0;
}

/* 2) highlight bar perfectly centered */
.range-highlight {
  position: absolute;
  top: 50%;
  height: 6px;                  /* match track thickness */
  transform: translateY(-50%);
  z-index: 1;
  border: none;                 /* remove side borders if you like */
  border-radius: 3px;
}

/* 3) make the two thumbs into vertical pills */
.range-input {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  background: transparent;
  z-index: 2;
}

/* WebKit pill‐style thumb */
.range-input::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 12px;
  height: 24px;
  margin-top: 0px;             /* (24px - trackHeight 6px)/2 */
  border-radius: 6px;
  background: #007bff;          /* or seg.color */
  cursor: pointer;
  z-index: 3;
}

/* Firefox pill‐style thumb */
.range-input::-moz-range-thumb {
  width: 12px;
  height: 24px;
  border-radius: 6px;
  background: #007bff;
  cursor: pointer;
  border: none;
}

/* hide the default track */
.range-input::-webkit-slider-runnable-track,
.range-input::-moz-range-track {
  background: transparent;
}


body .container #fullControl{
  flex-direction: row;
  padding-top: 24px;
  padding-bottom: 24px;
 box-shadow: 0 -2px 16px rgba(0, 0, 0, 0.03);
  border-radius: 0 0 32px 32px;

  background: #
}

/* seek control*/
.segment-handles {
  flex: 1;                /* fill the gap */
  position: relative;     /* positioning context */
  margin: 0;         /* optional side‐padding */
}

/* position the bar dead‐center inside .segment-handles */
.segment-handles #globalBar {
  position: absolute;
  top: 50%;
  left:   0;
  width: 100%;
  height: 6px;            /* your track thickness */
  margin: 0;
  transform: translateY(-50%);
}

/* layer the scrubber on top, same footprint */
#fullSeek {
  position: absolute;
  top: 50%;
  left:   0;
  width: 100%;
  height: 8px;            /* at least thumb‐height */
  transform: translateY(-50%);
  background: transparent;
  pointer-events: all;
  z-index: 2;             /* above the bar */
}

/* hide the native track and style the thumb */
#fullSeek::-webkit-slider-runnable-track,
#fullSeek::-moz-range-track {
  background: transparent;
}
#fullSeek::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px; height: 14px;
  margin-top: -3px;       /* center on 6px bar */
  border-radius: 50%;
  background: #007bff;
  border: 2px solid #fff;
  cursor: pointer;
  z-index: 3;
}
#fullSeek::-moz-range-thumb {
  width: 14px; height: 14px;
  border-radius: 50%;
  background: #007bff;
  border: 2px solid #fff;
  cursor: pointer;
  transform: translateY(-3px);
  z-index: 3;
}

/* 1) Remove any default track styling */
#fullSeek {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  background: transparent;
}

/* 2) Hide the track */
#fullSeek::-webkit-slider-runnable-track,
#fullSeek::-moz-range-track {
  height: 0;
  background: transparent;
}

/* 3) Style only the thumb as a circle */
#fullSeek::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #007bff;
  border: 2px solid #fff;
  margin-top: -4px;   /* vertically center over 6px bar */
  cursor: pointer;
}
#fullSeek::-moz-range-thumb {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #007bff;
  border: 2px solid #fff;
  transform: translateY(-4px);
  cursor: pointer;
}
.segment-handles #globalBar {


box-sizing: border-box;
}

/* 2) tooltip styling */
.seek-tooltip {
  position: absolute;
  top: -2.3rem;               /* float above the bar */
  transform: translateX(-73%);
  padding: 4px 6px;
  background: rgba(0,0,0,0.75);
  color: #fff;
  font-size: 0.75rem;
  border-radius: 4px;
  pointer-events: none;
  white-space: nowrap;
  display: none;
  z-index: 4;
}

.seek-tooltip {
  /* start invisible & smoothly transition opacity */
  opacity: 0;
  transition: opacity 300ms ease-out;
}

/* aligning seek thumb perfectly */

/* 1) Make sure the input still spans the full width and is centered over the bar */
.segment-handles #fullSeek {
  left: -10px;                         /* negative half-thumb width */
  width: calc(100% + 20px);            /* full + thumb width */
}


/* 2) vertically center a 20px thumb over an 8px bar */
#fullSeek::-webkit-slider-thumb {
  margin-top: -6px !important;         /* (20px thumb – 8px bar)/2 = 6px */
}
#fullSeek::-moz-range-thumb {
  transform: translateY(-6px) !important;

}
  /* play pause dynamic */

.play-btn, #mainPlay {
  /* size to your SVG, hide any text */
  width: 24px;
  height: 24px;
  padding: 0;
  background-repeat: no-repeat;
  background-position: center;
  background-size: contain;
  border: none;
  color: transparent;
  cursor: pointer;
}

/* default = play icon */
.play-btn, #mainPlay {
  background-image: url('play.svg');
  width: 32px;
  height: 32px;
 background-size: 24px 24px;
}

/* when paused (i.e. playing state), show pause icon */
.play-btn.paused, #mainPlay.paused {
  background-image: url('pause.svg');
}



.download-btn {
  width: 32px;
  height: 32px;
  padding: 0;
  border: none;
  background-image: url('download.svg');
  background-size: 26px 26px;
  color: transparent;  /* hide any inner text */
  background-repeat: no-repeat;
  background-position: center;

}

  </style>
</head>
<body>
  <div class="container">



    <!-- Preview + main play -->
    <div id="preview-wrapper">
      <div id="animation-container"></div>
      <div id="fullControl" class="segment-control" style="border-color:#888;">
      <div class="segment-header">
    <div class="segment-info">
  <div style=" font-size: 16px;">Full Animation</div>
      <div class="segment-frames" id="fullFramesCount">0 frames</div>
    </div>
      <div class="segment-handles">
      <div id="globalBar"></div>
      <input id="fullSeek" type="range" min="0" max="0" value="0" />
      <div id="seekTooltip" class="seek-tooltip"></div>
    </div>
    <div class="segment-actions">
      <div class="button-group">
        <button id="mainPlay" class="play-btn" disabled>Play All</button>
          <button id="downloadAll" class="download-btn" disabled></button>
        </div>
    </div>
  </div>
  </div>

    </div>




    <div class="controls">

      <div id="segmentsContainer"></div>
      <div class="button-group">

      </div>

    </div>
      <button id="addSegment" disabled>Add Segment</button>
  </div>

  <script>

  let originalData = null;

  window.addEventListener('message', (e) => {
    if (e.data.type === 'lottieData') {
      // Update JSON view
    originalData = e.data.data;
    console.log('loaded');
      // Destroy existing animation
      try {
        if (!originalData.v || !originalData.op || !originalData.fr) throw 'Invalid Lottie JSON';
        initAnim(originalData);
        console.log('initiated');
      } catch (err) {

      }
    }
  });




    const maxSegments = 10;
    const segmentColors = ['#e6194b','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4','#46f0f0','#f032e6','#bcf60c','#fabebe'];
    let  animation, totalFrames;
    const segments = [];
    let selectedSegmentId;
    let mainPlaying = false;







    const mainBtn = document.getElementById('mainPlay');
    mainBtn.onclick = () => {
      if (!animation) return;
      selectedSegmentId = null;

       animation.resetSegments(true);
      if (mainPlaying) {
        animation.loop = false;
        animation.pause();
        mainPlaying = false;
       mainBtn.classList.remove('paused');
      } else {
        animation.loop = true;
        animation.goToAndPlay(0, true);
        mainPlaying = true;
        mainBtn.classList.add('paused');
      }
    };




    function initAnim(data) {
      // always reset UI state …
      segments.length = 0;
      selectedSegmentId = null;
      mainPlaying = false;
      mainBtn.disabled = false;
      mainBtn.textContent = 'Play All';
      document.getElementById('segmentsContainer').innerHTML = '';

      if (animation) animation.destroy();

      /* hand Lottie a FRESH clone so it can mutate freely */
      const playbackData = JSON.parse(JSON.stringify(data));

      animation = lottie.loadAnimation({
        container : document.getElementById('animation-container'),
        animationData : playbackData,
        renderer  : 'svg',
        loop      : false,
        autoplay  : false
      });

      animation.addEventListener('DOMLoaded', () => {
        totalFrames = Math.floor(animation.totalFrames);

        document.getElementById('fullFramesCount').textContent = `${totalFrames} frames`;


        const fullSeek = document.getElementById('fullSeek');
 fullSeek.max = totalFrames;
 fullSeek.value = 0;

 // when you drag it, go to that frame
 fullSeek.addEventListener('input', e => {
   const f = +e.target.value;
   // goToAndStop works whether you're in a segment or full play
   animation.goToAndStop(f, true);
 });


 const tooltip = document.getElementById('seekTooltip');

 // on drag, update tooltip text & position
 fullSeek.addEventListener('input', e => {
   const f = +e.target.value;
   // show the frame
   tooltip.textContent = f;
   tooltip.style.display = 'block';

   tooltip.style.opacity = '1';
   // position above thumb
   const pct = f / totalFrames;
   const trackWidth = fullSeek.clientWidth;
   const x = 7 + pct * (trackWidth - 14); // +7 for left inset
   tooltip.style.left = `${x}px`;
 });

 // hide after release
 fullSeek.addEventListener('change', () => {
   // wait 2s, then fade out over 300ms, then hide
   setTimeout(() => {
     tooltip.style.opacity = '0';
     setTimeout(() => {
       tooltip.style.display = 'none';
     }, 300);
   }, 2000);
 });


 // as Lottie plays (full or segment), update the thumb
 animation.addEventListener('enterFrame', () => {
   fullSeek.value = Math.floor(animation.currentFrame);
 });



        document.getElementById('addSegment').disabled = false;
        document.getElementById('downloadAll').disabled = false;
        if (Array.isArray(data.markers)) loadMarkers(data.markers);
        drawGlobalBar();
      });
    }


    function loadMarkers(markers) {
      markers.slice(0, maxSegments).forEach((m, i) => {
        const start = Math.max(0, Math.floor(m.tm - originalData.ip));   // adjust for comp ip
        const duration = Math.max(1, Math.floor(m.dr));
        const end = Math.min(totalFrames, start + duration);
        segments.push({ id: Date.now() + i, start, end, name: m.cm || `Marker ${i+1}`, color: segmentColors[segments.length] });
      });
      renderSegments();
    }

    document.getElementById('addSegment').onclick = () => {
      if (segments.length >= maxSegments) return;
      const id = Date.now();
      const seg = { id, start: 0, end: totalFrames, name: `Segment ${segments.length+1}`, color: segmentColors[segments.length] };
      segments.push(seg);
      renderSegments();
      drawGlobalBar();
    };

    function renderSegments() {
      const container = document.getElementById('segmentsContainer'); container.innerHTML = '';
      segments.forEach(seg => {
        const el = document.createElement('div');
        el.className = 'segment-control'; el.style.borderColor = seg.color;
        el.innerHTML = `
    <div class="segment-header">
      <div class="segment-info">
        <input type="text" class="segment-name" data-id="${seg.id}" value="${seg.name}" />
        <div class="frame-inputs">
          <input type="number" class="frame-input" data-id="${seg.id}" data-type="start" value="${seg.start}" min="0" max="${totalFrames}" />
          <input type="number" class="frame-input" data-id="${seg.id}" data-type="end"   value="${seg.end}"   min="0" max="${totalFrames}" />
        </div>
      </div>
      <div class="segment-handles">
        <div class="range-container">
          <div class="range-highlight" id="highlight-${seg.id}" style="background:${seg.color}; border-color:${seg.color};"></div>
          <input type="range" class="range-input" data-id="${seg.id}" data-type="start" min="0" max="${totalFrames}" value="${seg.start}" />
          <input type="range" class="range-input" data-id="${seg.id}" data-type="end"   min="0" max="${totalFrames}" value="${seg.end}" />
        </div>
      </div>
      <div class="segment-actions">
        <button class="play-btn"     data-id="${seg.id}">Play</button>
        <button class="download-btn" data-id="${seg.id}"></button>
      </div>
    </div>
  `;
        container.appendChild(el);
      });

      // handlers
      container.querySelectorAll('.segment-name').forEach(i => i.oninput = e => segments.find(s=>s.id==e.target.dataset.id).name=e.target.value);
      container.querySelectorAll('.frame-input').forEach(input => {
        input.oninput = e => {
          const seg = segments.find(s=>s.id==e.target.dataset.id);
          const val = Math.floor(+e.target.value);
          if (e.target.dataset.type==='start') seg.start=Math.min(val,seg.end-1);
          else seg.end=Math.max(val,seg.start+1);
          syncSegment(seg);
        };
      });
      container.querySelectorAll('.range-input').forEach(input => {
        input.oninput = e => {
          const seg = segments.find(s=>s.id==e.target.dataset.id);
          const val = Math.floor(+e.target.value);
          if (e.target.dataset.type==='start') seg.start=Math.min(val,seg.end-1);
          else seg.end=Math.max(val,seg.start+1);
          syncSegment(seg);
        };
      });
      container.querySelectorAll('.play-btn').forEach(btn => btn.onclick = handlePlay);
      container.querySelectorAll('.download-btn').forEach(btn => btn.onclick = handleDownload);
      segments.forEach(s=>updateHighlight(s));
    }

    function syncSegment(seg) {
      updateHighlight(seg);
      drawGlobalBar();
      document.querySelector(`.range-input[data-id='${seg.id}'][data-type='start']`).value=seg.start;
      document.querySelector(`.range-input[data-id='${seg.id}'][data-type='end']`).value=seg.end;
      document.querySelector(`.frame-input[data-id='${seg.id}'][data-type='start']`).value=seg.start;
      document.querySelector(`.frame-input[data-id='${seg.id}'][data-type='end']`).value=seg.end;
      if (selectedSegmentId===seg.id) playSeg(seg);
    }

    function handlePlay(e) {
      const id = +e.target.dataset.id;
      if (mainPlaying) mainBtn.onclick();
      if (selectedSegmentId===id) {
        animation.loop=false; animation.pause(); selectedSegmentId=null; e.target.classList.remove('paused');
      } else {
        selectedSegmentId=id; document.querySelectorAll('.play-btn').forEach(b=>b.textContent='Play');
        e.target.classList.add('paused'); animation.loop=true; playSeg(segments.find(s=>s.id===id));
      }
    }

    function handleDownload(e) {
      const seg=segments.find(s=>s.id==e.target.dataset.id);
      // single-segment download
      const mod = stripRuntimeFlags(JSON.parse(JSON.stringify(originalData)));
    mod.ip = seg.start;
    mod.op = seg.end;
    mod.markers = [{ cm: seg.name, tm: 0, dr: seg.end - seg.start }];
    downloadJSON(mod, `trimmed_${seg.name}_${seg.start}_${seg.end}.json`);

    }

    function updateHighlight(seg) {
      const hl=document.getElementById(`highlight-${seg.id}`);
      hl.style.left=`${(seg.start/totalFrames)*100}%`;
      hl.style.width=`${((seg.end-seg.start)/totalFrames)*100}%`;
    }

    function playSeg(seg) { animation.playSegments([seg.start,seg.end],true); }
    function drawGlobalBar() {
      const bar=document.getElementById('globalBar'); bar.innerHTML='';
      segments.forEach(seg=>{ const d=document.createElement('div'); d.style.position='absolute';
        d.style.left=`${(seg.start/totalFrames)*100}%`; d.style.width=`${((seg.end-seg.start)/totalFrames)*100}%`;
        d.style.height='100%'; d.style.background=seg.color; d.style.borderRadius='4px'; bar.appendChild(d);
      });
    }

    document.getElementById('downloadAll').onclick=()=>{
      // “Download JSON with Markers”
      const mod = stripRuntimeFlags(JSON.parse(JSON.stringify(originalData)));
      mod.markers = segments.map(s => ({ cm: s.name, tm: s.start + originalData.ip, dr: s.end - s.start }));

      downloadJSON(mod, 'with_markers.json');
    };

    function stripRuntimeFlags(obj) {
      if (Array.isArray(obj)) {
        return obj.map(stripRuntimeFlags);        // keep arrays intact
      }

      if (obj && typeof obj === 'object') {
        const out = {};
        for (const [k, v] of Object.entries(obj)) {
          if (k.startsWith('_') || k === 'completed' || k === '__complete') {
            continue;                             // drop helper flag
          }
          out[k] = stripRuntimeFlags(v);          // keep everything else
        }
        return out;
      }

      return obj;  // primitives
    }

    function downloadJSON(data, filename) {
      // Serialize exactly what’s in memory, so Lottie viewers see a valid file
      const jsonString = JSON.stringify(data);

      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    }

  setTimeout(() => {
     if (!originalData) {
       fetch('default.json')
         .then(res => res.json())
         .then(data => {
           originalData = data;
           initAnim(data);
         })
         .catch(err => console.error('Failed to load default.json:', err));
     }
   }, 300);

  </script>
</body>
</html>
