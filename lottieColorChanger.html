<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lottie Color Editor with Preview & Hex Input</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: #f5f5f5;
      display: flex;
      flex-direction: row;
      gap: 2rem;
    }
    #editorArea, #previewArea {
      flex: 1;
    }
    input[type="file"] {
      margin-bottom: 1rem;
    }
    .color-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }
    .color-row label {
      flex: 1;
      font-size: 14px;
    }
    .color-row input[type="color"],
    .color-row input[type="text"] {
      width: 80px;
      padding: 4px;
      font-size: 14px;
    }
    .color-row input[type="text"] {
      width: 90px;
    }
    button {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
    }
    #lottiePreview {
      width: 100%;
      max-width: 400px;
      height: 400px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1rem;
    }
  </style>
</head>
<body>

  <div id="editorArea">
    <h2>Edit Lottie Colors</h2>
    <input type="file" id="fileInput" accept=".json" />
    <div id="colorEditor"></div>
    <button id="downloadBtn" style="display:none;">Download Updated JSON</button>
  </div>

  <div id="previewArea">
    <h2>Live Preview</h2>
    <div id="lottiePreview"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <script>
    let lottieData;
    let colorRefs = [];
    let animationInstance;

    function rgbToHex(r, g, b) {
      return "#" + [r, g, b].map(x =>
        Math.round(x * 255).toString(16).padStart(2, "0")
      ).join("");
    }

    function hexToRgb(hex) {
      const bigint = parseInt(hex.slice(1), 16);
      return [
        ((bigint >> 16) & 255) / 255,
        ((bigint >> 8) & 255) / 255,
        (bigint & 255) / 255
      ];
    }

    function findColors(obj, path = []) {
      if (Array.isArray(obj)) {
        obj.forEach((item, i) => findColors(item, [...path, i]));
      } else if (typeof obj === 'object' && obj !== null) {
        if (
          obj.hasOwnProperty('c') &&
          obj.c.hasOwnProperty('k') &&
          Array.isArray(obj.c.k) &&
          obj.c.k.length >= 3 &&
          obj.c.k.length <= 4
        ) {
          colorRefs.push({
            path: [...path, 'c', 'k'],
            original: obj.c.k
          });
        }

        for (let key in obj) {
          findColors(obj[key], [...path, key]);
        }
      }
    }

    function getValueByPath(obj, path) {
      return path.reduce((acc, key) => acc[key], obj);
    }

    function setValueByPath(obj, path, newValue) {
      const lastKey = path[path.length - 1];
      const target = path.slice(0, -1).reduce((acc, key) => acc[key], obj);
      target[lastKey] = newValue;
    }

    function updateColor(ref, newHex) {
      const rgb = hexToRgb(newHex);
      const currentAlpha = getValueByPath(lottieData, ref.path)[3] ?? 1;
      const finalColor = [...rgb, currentAlpha];
      setValueByPath(lottieData, ref.path, finalColor);
      reloadLottiePreview();
    }

    function renderColorPickers() {
      const editor = document.getElementById('colorEditor');
      editor.innerHTML = "";

      colorRefs.forEach((ref, i) => {
        const [r, g, b] = getValueByPath(lottieData, ref.path);
        const hex = rgbToHex(r, g, b);

        const row = document.createElement("div");
        row.className = "color-row";

        const label = document.createElement("label");
        label.textContent = `Color ${i + 1}`;

        const colorInput = document.createElement("input");
        colorInput.type = "color";
        colorInput.value = hex;

        const hexInput = document.createElement("input");
        hexInput.type = "text";
        hexInput.value = hex;

        // Sync from color picker
        colorInput.addEventListener("input", (e) => {
          const newHex = e.target.value;
          hexInput.value = newHex;
          updateColor(ref, newHex);
        });

        // Sync from hex input
        hexInput.addEventListener("change", (e) => {
          let newHex = e.target.value;
          if (!newHex.startsWith("#")) newHex = "#" + newHex;
          if (/^#[0-9A-F]{6}$/i.test(newHex)) {
            colorInput.value = newHex;
            updateColor(ref, newHex);
          } else {
            alert("Invalid hex code. Use format like #FF0000.");
            hexInput.value = colorInput.value;
          }
        });

        row.appendChild(label);
        row.appendChild(colorInput);
        row.appendChild(hexInput);
        editor.appendChild(row);
      });

      if (colorRefs.length > 0) {
        document.getElementById("downloadBtn").style.display = "inline-block";
      }
    }

    function reloadLottiePreview() {
      if (animationInstance) {
        animationInstance.destroy();
      }

      animationInstance = lottie.loadAnimation({
        container: document.getElementById('lottiePreview'),
        renderer: 'svg',
        loop: true,
        autoplay: true,
        animationData: lottieData
      });
    }

    document.getElementById("fileInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          lottieData = JSON.parse(e.target.result);
          colorRefs = [];
          findColors(lottieData);
          renderColorPickers();
          reloadLottiePreview();
        } catch (err) {
          alert("Invalid Lottie JSON");
        }
      };
      reader.readAsText(file);
    });

    document.getElementById("downloadBtn").addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(lottieData, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "updated_lottie.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });
  </script>

</body>
</html>
